---
import { getCollection, render } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';

const { slug } = Astro.params;
const { user } = Astro.locals;

// Find the post
const posts = await getCollection('posts');
const post = posts.find((p) => p.id.replace(/\.md$/, '') === slug);

if (!post) {
  return Astro.redirect('/');
}

// Gate investor-only posts behind auth
if (post.data.investorOnly && !user) {
  return Astro.redirect('/login?redirect=' + encodeURIComponent(Astro.url.pathname));
}

const { Content } = await render(post);
---

<PostLayout
  title={post.data.title}
  date={post.data.date}
  investorOnly={post.data.investorOnly}
>
  <Content />
</PostLayout>
